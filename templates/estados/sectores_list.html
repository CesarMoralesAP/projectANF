{% extends "base.html" %}
{% load static %}
{% block content %}
<div class="container mt-5">
  <div class="card shadow">
    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
      <h4 class="mb-0">Sectores registrados</h4>
      <a href="{% url 'crear_sector' %}" class="btn btn-light btn-sm">+ Nuevo sector</a>
    </div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-hover align-middle">
          <thead class="table-light">
            <tr>
              <th>#</th>
              <th>Nombre</th>
              <th>Descripción</th>
              <th>Ratios Financieros</th>
              <th class="text-center">Acciones</th>
            </tr>
          </thead>
          <tbody>
            {% for sector in sectores %}
              <tr>
                <td>{{ forloop.counter }}</td>
                <td><strong>{{ sector.nombre }}</strong></td>
                <td>{{ sector.descripcion|default:"—" }}</td>
                <td id="ratios-{{ sector.id }}">
                  <span class="text-muted">Cargando...</span>
                </td>
                <td class="text-center">
                  <a href="{% url 'editar_sector' sector.id %}" class="btn btn-warning btn-sm me-1 mb-1 d-inline-block">Editar</a>
                  <a href="{% url 'eliminar_sector' sector.id %}" class="btn btn-danger btn-sm mb-1 d-inline-block">Eliminar</a>
                </td>
              </tr>
              <script>
                (function() {
                  try {
                    const data = JSON.parse(`{{ sector.valor_referencia|escapejs }}`);
                    const container = document.getElementById("ratios-{{ sector.id }}");
                    container.innerHTML = "";
                    Object.entries(data).forEach(([key, value]) => {
                      const badge = document.createElement("span");
                      badge.classList.add("badge", "bg-secondary", "me-1", "mb-1");
                      badge.textContent = `${key}: ${value}`;
                      container.appendChild(badge);
                    });
                  } catch (e) {
                    document.getElementById("ratios-{{ sector.id }}").innerHTML =
                      '<span class="text-muted">Sin parámetros</span>';
                  }
                })();
              </script>
            {% empty %}
              <tr>
                <td colspan="5" class="text-center text-muted">No hay sectores registrados.</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
{% endblock %}