{% extends 'dashboard/base.html' %}
{% load static %}
{% load permisos_tags %}

{% block title %}Historial de Proyecciones - Sistema de An√°lisis Financiero{% endblock %}

{% block content %}
<div class="content-header">
    <div class="content-title">
        <h2>Historial de Proyecciones</h2>
        <p>Todas las proyecciones guardadas en el sistema</p>
    </div>
    <a href="{% url 'graficas:graficos_lista' %}" class="btn btn-primary">
        <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" width="16" height="16">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
        </svg>
        <span>Nueva Proyecci√≥n</span>
    </a>
</div>

{% if proyecciones %}
<div class="card" style="margin-top: 1.5rem;">
    <div class="card-content" style="padding: 0;">
        <div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="background: #f9fafb; border-bottom: 2px solid #e5e7eb;">
                        <th style="padding: 1rem; text-align: left; font-weight: 600; color: #374151;">Nombre</th>
                        <th style="padding: 1rem; text-align: left; font-weight: 600; color: #374151;">Empresa</th>
                        <th style="padding: 1rem; text-align: left; font-weight: 600; color: #374151;">Sector</th>
                        <th style="padding: 1rem; text-align: left; font-weight: 600; color: #374151;">Fecha</th>
                        <th style="padding: 1rem; text-align: left; font-weight: 600; color: #374151;">Origen</th>
                        <th style="padding: 1rem; text-align: center; font-weight: 600; color: #374151;">Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for proyeccion in proyecciones %}
                    <tr style="border-bottom: 1px solid #e5e7eb;">
                        <td style="padding: 1rem;">
                            <div style="font-weight: 500; color: #111827;">{{ proyeccion.nombre }}</div>
                            {% if proyeccion.descripcion %}
                            <div style="font-size: 0.875rem; color: #6b7280; margin-top: 0.25rem;">
                                {{ proyeccion.descripcion|truncatewords:10 }}
                            </div>
                            {% endif %}
                        </td>
                        <td style="padding: 1rem; color: #374151;">{{ proyeccion.empresa.nombre }}</td>
                        <td style="padding: 1rem; color: #6b7280;">{{ proyeccion.empresa.sector.nombre }}</td>
                        <td style="padding: 1rem; color: #6b7280; white-space: nowrap;">
                            {{ proyeccion.creado_en|date:"d/m/Y H:i" }}
                        </td>
                        <td style="padding: 1rem;">
                            {% if proyeccion.origen == 'ARCHIVO' %}
                                <span style="display: inline-block; padding: 0.25rem 0.75rem; background: #dbeafe; color: #1e40af; border-radius: 9999px; font-size: 0.75rem; font-weight: 600;">
                                    üìÑ Excel
                                </span>
                            {% else %}
                                <span style="display: inline-block; padding: 0.25rem 0.75rem; background: #dcfce7; color: #166534; border-radius: 9999px; font-size: 0.75rem; font-weight: 600;">
                                    üî¢ Calculado
                                </span>
                            {% endif %}
                        </td>
                        <td style="padding: 1rem;">
                            <div style="display: flex; gap: 0.5rem; justify-content: center; flex-wrap: wrap;">
                                <!-- Bot√≥n Ver Gr√°fico -->
                                <a href="{% url 'graficas:ver_grafico' proyeccion.pk %}" 
                                   class="btn btn-primary"
                                   style="font-size: 0.875rem; padding: 0.5rem 1rem;">
                                    üìä Ver Gr√°fico
                                </a>
                                
                                <!-- Bot√≥n Descargar Excel (solo si es de archivo) -->
                                {% if proyeccion.archivo %}
                                <a href="{{ proyeccion.archivo.url }}" 
                                   download
                                   class="btn btn-secondary"
                                   style="font-size: 0.875rem; padding: 0.5rem 1rem;"
                                   title="Descargar Excel original">
                                    üì• Excel
                                </a>
                                {% endif %}
                                
                                <!-- Bot√≥n Eliminar (solo para administradores) -->
                                {% if request.user|es_administrador %}
                                <button onclick="confirmarEliminacion('{{ proyeccion.nombre }}', '{% url 'graficas:eliminar_proyeccion' proyeccion.pk %}')"
                                        class="btn btn-danger"
                                        style="font-size: 0.875rem; padding: 0.5rem 1rem;"
                                        title="Eliminar proyecci√≥n">
                                    üóëÔ∏è Eliminar
                                </button>
                                {% else %}
                                <button class="btn btn-secondary"
                                        style="font-size: 0.875rem; padding: 0.5rem 1rem; opacity: 0.5; cursor: not-allowed;"
                                        title="Solo administradores pueden eliminar"
                                        disabled>
                                    üîí Eliminar
                                </button>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Paginaci√≥n (si hay muchas proyecciones) -->
{% if is_paginated %}
<div style="margin-top: 2rem; display: flex; justify-content: center; gap: 0.5rem;">
    {% if page_obj.has_previous %}
        <a href="?page=1" class="btn btn-secondary">Primera</a>
        <a href="?page={{ page_obj.previous_page_number }}" class="btn btn-secondary">Anterior</a>
    {% endif %}
    
    <span style="padding: 0.5rem 1rem; background: #f9fafb; border-radius: 6px; color: #374151;">
        P√°gina {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}
    </span>
    
    {% if page_obj.has_next %}
        <a href="?page={{ page_obj.next_page_number }}" class="btn btn-secondary">Siguiente</a>
        <a href="?page={{ page_obj.paginator.num_pages }}" class="btn btn-secondary">√öltima</a>
    {% endif %}
</div>
{% endif %}

{% else %}
<div class="info-note" style="margin-top: 2rem; text-align: center;">
    <p style="font-size: 1.125rem; margin-bottom: 1rem;">üìä No hay proyecciones guardadas</p>
    <p>Crea tu primera proyecci√≥n desde el men√∫ "Informes y An√°lisis"</p>
    <a href="{% url 'graficas:graficos_lista' %}" class="btn btn-primary" style="margin-top: 1rem; display: inline-block;">
        Crear Proyecci√≥n
    </a>
</div>
{% endif %}

<div class="info-note" style="margin-top: 2rem;">
    <strong>üí° Informaci√≥n:</strong>
    <ul style="margin: 0.5rem 0 0 1.5rem; padding: 0;">
        <li>Las proyecciones se guardan autom√°ticamente al procesarse</li>
        <li>Puedes ver el gr√°fico en cualquier momento</li>
        <li>Los archivos Excel originales est√°n disponibles para descarga</li>
        <li>Solo administradores pueden eliminar proyecciones</li>
    </ul>
</div>

<!-- Modal de confirmaci√≥n de eliminaci√≥n -->
<div id="modalEliminar" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; align-items: center; justify-content: center;">
    <div style="background: white; padding: 2rem; border-radius: 8px; max-width: 500px; width: 90%;">
        <h3 style="margin: 0 0 1rem 0; color: #dc2626;">‚ö†Ô∏è Confirmar Eliminaci√≥n</h3>
        <p style="margin-bottom: 1.5rem; color: #374151;">
            ¬øEst√° seguro que desea eliminar la proyecci√≥n <strong id="nombreProyeccion"></strong>?
        </p>
        <p style="color: #dc2626; font-size: 0.875rem; margin-bottom: 1.5rem;">
            Esta acci√≥n no se puede deshacer.
        </p>
        <div style="display: flex; gap: 1rem; justify-content: flex-end;">
            <button onclick="cerrarModalEliminar()" class="btn btn-secondary">
                Cancelar
            </button>
            <form id="formEliminar" method="post" style="margin: 0;">
                {% csrf_token %}
                <button type="submit" class="btn btn-danger">
                    Eliminar
                </button>
            </form>
        </div>
    </div>
</div>

<script>
function confirmarEliminacion(nombre, url) {
    document.getElementById('nombreProyeccion').textContent = nombre;
    document.getElementById('formEliminar').action = url;
    document.getElementById('modalEliminar').style.display = 'flex';
}

function cerrarModalEliminar() {
    document.getElementById('modalEliminar').style.display = 'none';
}

// Cerrar modal al hacer clic fuera de √©l
document.getElementById('modalEliminar').addEventListener('click', function(e) {
    if (e.target === this) {
        cerrarModalEliminar();
    }
});
</script>
{% endblock %}
