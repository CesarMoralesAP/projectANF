{% extends "base.html" %}
{% load humanize %}
{% block content %}
<div class="container mt-5">
  <div class="card shadow-lg">
    <div class="card-header bg-success text-white">
      <h4>Proyección de Ventas {{ empresa.nombre }} — Método: {{ metodo }}</h4>
    </div>
    <div class="card-body">

      <canvas id="graficaProyeccion" height="100"></canvas>

      {% if ecuacion %}
        <p class="mt-3 text-muted">Ecuación de la tendencia: <strong>{{ ecuacion }}</strong></p>
      {% endif %}

    <hr>
    <h5>Tabla de Proyección {{ anio }}</h5>
    <table class="table table-striped table-hover align-middle">
        <thead class="table-success">
            <tr>
                <th>Mes</th>
                <th>Valor proyectado ($)</th>
            </tr>
        </thead>
        <tbody>
            {% for mes, valor in proyecciones_tabla %}
            <tr>
                <td>{{ mes }}</td>
                <td>${{ valor|floatformat:2|intcomma }}</td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="2" class="text-center text-muted">No hay proyecciones disponibles.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
      <a href="{% url 'cargar_proyeccion' %}" class="btn btn-primary mt-3">← Volver a cargar archivo</a>
    </div>
  </div>
</div>

<!-- Script Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const ctx = document.getElementById('graficaProyeccion');
const mesesHist = {{ meses_hist|safe }};
const valoresHist = {{ valores_hist|safe }};
const mesesProj = {{ meses_proj|safe }};
const valoresProj = {{ valores_proj|safe }};

new Chart(ctx, {
  type: 'line',
  data: {
    labels: mesesHist.concat(mesesProj),
    datasets: [
      {
        label: 'Histórico (Excel)',
        data: valoresHist,
        borderColor: 'rgba(54, 162, 235, 1)',
        backgroundColor: 'rgba(54, 162, 235, 0.2)',
        tension: 0.3
      },
      {
        label: 'Proyección ({{ metodo }})',
        data: new Array(valoresHist.length).fill(null).concat(valoresProj),
        borderColor: 'rgba(255, 99, 132, 1)',
        backgroundColor: 'rgba(255, 99, 132, 0.2)',
        borderDash: [5, 5],
        tension: 0.3
      }
    ]
  },
  options: {
    responsive: true,
    plugins: {
      legend: { position: 'bottom' },
      title: { display: true, text: 'Evolución de Ventas y Proyección' }
    },
    scales: { y: { beginAtZero: false } }
  }
});
</script>
{% endblock %}
